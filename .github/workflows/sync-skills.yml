name: Sync skills to dependent repos

# 謇句虚螳溯｡後・縺ｿ縲・
# .claude/commands/ 縺ｮ繧ｹ繧ｭ繝ｫ繝輔ぃ繧､繝ｫ繧貞・萓晏ｭ倥Μ繝昴ず繝医Μ縺ｫ蜷梧悄縺励・
# SessionStart 繝輔ャ繧ｯ繧りｨｭ螳壹＠縺ｦ莉･髯阪・閾ｪ蜍募酔譛溘ｒ譛牙柑蛹悶☆繧九・

on:
  workflow_dispatch:
    inputs:
      repos:
        description: '蜷梧悄蟇ｾ雎｡繝ｪ繝昴ず繝医Μ・医き繝ｳ繝槫玄蛻・ｊ縲∫ｩｺ=蜈ｨ縺ｦ・・
        required: false
        type: string
      dry_run:
        description: 'Dry run・・R 繧剃ｽ懈・縺励↑縺・ｼ・
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          # 笏笏 Tier 1: 讌ｭ蜍吝､蛾擠繝・・繝ｫ 笏笏
          - repo: win-app-nocode-analyzer
            product: INCA
            name: InsightNoCodeAnalyzer
          - repo: win-app-insight-bot
            product: INBT
            name: InsightBot
          - repo: web-app-auto-interview
            product: IVIN
            name: InterviewInsight

          # 笏笏 Tier 2: AI豢ｻ逕ｨ繝・・繝ｫ 笏笏
          - repo: win-app-insight-cast
            product: INMV
            name: InsightCast
          - repo: win-app-insight-image-gen
            product: INIG
            name: InsightImageGen

          # 笏笏 Tier 3: InsightOffice Suite 笏笏
          - repo: win-app-insight-slide
            product: INSS
            name: InsightOfficeSlide
          - repo: win-app-insight-sheet
            product: IOSH
            name: InsightOfficeSheet
          - repo: win-app-insight-doc
            product: IOSD
            name: InsightOfficeDoc
          - repo: win-app-insight-py
            product: INPY
            name: InsightPy
          - repo: win-app-insight-py-pro
            product: INPY
            name: InsightPy (PRO)

          # 笏笏 Tier 4: 繧ｷ繝九い蜷代￠ 笏笏
          - repo: win-app-insight-sheet-senior
            product: ISOF
            name: InsightSeniorOffice

          # 笏笏 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ 笏笏
          - repo: win-app-insight-launcher
            product: LAUNCHER
            name: InsightLauncher
          - repo: android-app-insight-launcher
            product: LAUNCHER_ANDROID
            name: InsightLauncherAndroid

          # 笏笏 Android Native (Kotlin/Compose) 笏笏
          - repo: android-app-insight-voice-clock
            product: VOICE_CLOCK
            name: InsightVoiceClock
          - repo: android-app-insight-camera
            product: CAMERA
            name: InsightCamera

          # 笏笏 Expo / React Native 笏笏
          - repo: mobile-app-voice-memo
            product: VOICE_MEMO
            name: InsightVoiceMemo

          # 笏笏 WPF (C#) 笏笏
          - repo: win-app-insight-pinboard
            product: PINBOARD
            name: InsightPinBoard

          # 笏笏 Web / Android QR 笏笏
          - repo: web-app-insight-qr
            product: QR
            name: InsightQR (Web)
          - repo: android-app-insight-qr
            product: QR
            name: InsightQR (Android)

          # 笏笏 繧ｳ繝ｳ繧ｵ繝ｫ繝・ぅ繝ｳ繧ｰ繝・・繝ｫ 笏笏
          - repo: android-app-consul-evaluate
            product: CONSUL_EVAL
            name: ConsulEvaluate

          # 笏笏 Android Native (Voice Task Calendar) 笏笏
          - repo: android-app-voice-tesk-calendar
            product: VOICE_TASK_CALENDAR
            name: InsightVoiceTaskCalendar

    steps:
      - name: Validate SYNC_PAT secret
        run: |
          if [ -z "${{ secrets.SYNC_PAT }}" ]; then
            echo "::error::SYNC_PAT secret is not configured."
            exit 1
          fi

      - name: Check if repo should be synced
        id: check
        run: |
          FILTER="${{ inputs.repos }}"
          if [ -n "$FILTER" ]; then
            if echo "$FILTER" | grep -qw "${{ matrix.repo }}"; then
              echo "skip=false" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout insight-common
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          path: insight-common

      - name: Checkout target repo
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: HarmonicInsight/${{ matrix.repo }}
          token: ${{ secrets.SYNC_PAT }}
          path: target-repo
          fetch-depth: 0

      - name: Sync skill files
        if: steps.check.outputs.skip != 'true'
        run: |
          SRC="insight-common/.claude/commands"
          DEST="target-repo/.claude/commands"

          mkdir -p "$DEST"

          # 蜈ｨ繧ｹ繧ｭ繝ｫ繝輔ぃ繧､繝ｫ繧偵さ繝斐・
          SYNCED=0
          for src_file in "$SRC"/*.md; do
            [ -f "$src_file" ] || continue
            filename="$(basename "$src_file")"
            dest_file="$DEST/$filename"

            if [ -f "$dest_file" ] && cmp -s "$src_file" "$dest_file"; then
              echo "  unchanged: $filename"
              continue
            fi

            cp "$src_file" "$dest_file"
            SYNCED=$((SYNCED + 1))
            echo "  synced: $filename"
          done

          echo "skills_synced=$SYNCED" >> "$GITHUB_ENV"
          echo "Total skills synced: $SYNCED"

      - name: Ensure SessionStart hook for sync-skills
        if: steps.check.outputs.skip != 'true'
        run: |
          SETTINGS="target-repo/.claude/settings.json"
          SYNC_CMD='bash ${CLAUDE_PROJECT_DIR}/insight-common/scripts/sync-skills.sh'

          # sync-skills.sh 繧ゅさ繝斐・
          if [ -d "target-repo/insight-common/scripts" ]; then
            echo "insight-common submodule detected 窶・sync-skills.sh available via submodule"
          else
            echo "No insight-common submodule 窶・sync-skills hook will work after submodule init"
          fi

          if [ -f "$SETTINGS" ]; then
            # settings.json 縺梧里縺ｫ蟄伜惠縺吶ｋ蝣ｴ蜷医《ync-skills 繝輔ャ繧ｯ縺後≠繧九°遒ｺ隱・
            if grep -q "sync-skills.sh" "$SETTINGS" 2>/dev/null; then
              echo "SessionStart hook already configured"
              echo "hook_updated=false" >> "$GITHUB_ENV"
            else
              echo "Adding sync-skills hook to existing settings.json"
              # jq 縺ｧ SessionStart 繝輔ャ繧ｯ繧定ｿｽ蜉・域里蟄倥・繝輔ャ繧ｯ繧貞｣翫＆縺ｪ縺・ｼ・
              if command -v jq &> /dev/null; then
                HOOK='{"type":"command","command":"bash ${CLAUDE_PROJECT_DIR}/insight-common/scripts/sync-skills.sh"}'
                ENTRY="{\"matcher\":\"\",\"hooks\":[$HOOK]}"

                # SessionStart 繧ｭ繝ｼ縺悟ｭ伜惠縺吶ｋ縺狗｢ｺ隱・
                if jq -e '.hooks.SessionStart' "$SETTINGS" > /dev/null 2>&1; then
                  # 譌｢蟄倥・ SessionStart 驟榊・縺ｫ霑ｽ蜉
                  jq --argjson entry "$ENTRY" '.hooks.SessionStart += [$entry]' "$SETTINGS" > "${SETTINGS}.tmp"
                else
                  # hooks.SessionStart 繧呈眠隕丈ｽ懈・
                  jq --argjson entry "$ENTRY" '.hooks.SessionStart = [$entry]' "$SETTINGS" > "${SETTINGS}.tmp"
                fi
                mv "${SETTINGS}.tmp" "$SETTINGS"
                echo "hook_updated=true" >> "$GITHUB_ENV"
              else
                echo "::warning::jq not available 窶・cannot merge settings.json safely"
                echo "hook_updated=false" >> "$GITHUB_ENV"
              fi
            fi
          else
            # settings.json 縺悟ｭ伜惠縺励↑縺・ｴ蜷医・譁ｰ隕丈ｽ懈・
            echo "Creating new .claude/settings.json"
            mkdir -p "$(dirname "$SETTINGS")"
            cat > "$SETTINGS" << 'SETTINGSEOF'
          {
            "hooks": {
              "SessionStart": [
                {
                  "matcher": "",
                  "hooks": [
                    {
                      "type": "command",
                      "command": "bash ${CLAUDE_PROJECT_DIR}/insight-common/scripts/sync-skills.sh"
                    }
                  ]
                }
              ]
            }
          }
          SETTINGSEOF
            echo "hook_updated=true" >> "$GITHUB_ENV"
          fi

      - name: Check for changes
        if: steps.check.outputs.skip != 'true'
        id: changes
        working-directory: target-repo
        run: |
          git add .claude/
          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No skill changes in ${{ matrix.repo }}"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Skill changes detected in ${{ matrix.repo }}:"
            git diff --cached --stat
          fi

      - name: Commit and push directly to main
        if: >-
          steps.check.outputs.skip != 'true' &&
          steps.changes.outputs.has_changes == 'true' &&
          inputs.dry_run != true
        working-directory: target-repo
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          COMMIT_MSG="chore: sync Claude Code skills from insight-common (${SHORT_SHA})"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "$COMMIT_MSG"
          git push origin HEAD
          echo "Pushed skill sync to main for ${{ matrix.repo }}"
