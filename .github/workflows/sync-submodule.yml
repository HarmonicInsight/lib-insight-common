name: Sync icons to dependent repos

# 手動実行�Eみ、E
# brand/icons を変更した後、忁E��なリポジトリにアイコンをコピ�Eして PR を作�Eする、E
# push トリガーは無効化済み�E�無陁EPR 生�Eを防止�E�、E

on:
  workflow_dispatch:
    inputs:
      repos:
        description: '同期対象リポジトリ�E�カンマ区刁E��、空=全て�E�E
        required: false
        type: string
      dry_run:
        description: 'Dry run�E�ER を作�EしなぁE��E
        required: false
        type: boolean
        default: false
      sync_submodule:
        description: 'サブモジュール参�Eも更新する'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  ICON_SRC_BASE: brand/icons/generated
  SUBMODULE_PATH: insight-common

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          # ── Tier 1: 業務変革チE�Eル ──
          - repo: win-app-nocode-analyzer
            product: INCA
            name: InsightNoCodeAnalyzer
            icon_src: InsightNoCodeAnalyzer/
            icon_dest: src-tauri/icons/
            copy_mode: dir

          - repo: win-app-insight-bot
            product: INBT
            name: InsightBot
            icon_src: InsightBot
            icon_dest: Resources
            copy_mode: ico_png

          - repo: web-app-auto-interview
            product: IVIN
            name: InterviewInsight
            icon_src: InterviewInsight/
            icon_dest: src-tauri/icons/
            copy_mode: dir

          # ── Tier 2: AI活用チE�Eル ──
          - repo: win-app-insight-cast
            product: INMV
            name: Insight Training Studio
            icon_src: InsightCast
            icon_dest: resources
            copy_mode: ico_png

          - repo: win-app-insight-image-gen
            product: INIG
            name: InsightImageGen
            icon_src: InsightImageGen
            icon_dest: resources
            copy_mode: ico_png

          # ── Tier 3: Insight Business Suite ──
          - repo: win-app-insight-slide
            product: INSS
            name: Insight Deck Quality Gate
            icon_src: InsightOfficeSlide
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-sheet
            product: IOSH
            name: Insight Performance Management
            icon_src: InsightPerformanceManagement
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-doc
            product: IOSD
            name: Insight AI Doc Factory
            icon_src: InsightAIDocFactory
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-py
            product: INPY
            name: InsightPy
            icon_src: InsightPy
            icon_dest: resources
            copy_mode: ico_png

          - repo: win-app-insight-py-pro
            product: INPY
            name: InsightPy
            icon_src: InsightPy
            icon_dest: resources
            copy_mode: ico_png

          # ── Tier 4: シニア向け ──
          - repo: win-app-insight-sheet-senior
            product: ISOF
            name: InsightSeniorOffice
            icon_src: InsightSeniorOffice
            icon_dest: Resources
            copy_mode: ico_png

          # ── ユーチE��リチE�� ──
          - repo: win-app-insight-launcher
            product: LAUNCHER
            name: InsightLauncher
            icon_src: InsightLauncher
            icon_dest: Resources
            copy_mode: ico_png

          - repo: android-app-insight-launcher
            product: LAUNCHER_ANDROID
            name: InsightLauncherAndroid
            icon_src: InsightLauncherAndroid
            icon_dest: app/src/main/res
            copy_mode: android_native

          # ── Android Native (Kotlin/Compose) ──
          - repo: android-app-insight-voice-clock
            product: VOICE_CLOCK
            name: InsightVoiceClock
            icon_src: InsightVoiceClock
            icon_dest: app/src/main/res
            copy_mode: android_native

          - repo: android-app-insight-camera
            product: CAMERA
            name: InsightCamera
            icon_src: InsightCamera
            icon_dest: app/src/main/res
            copy_mode: android_native

          # ── Expo / React Native ──
          - repo: mobile-app-voice-memo
            product: VOICE_MEMO
            name: InsightVoiceMemo
            icon_src: InsightVoiceMemo
            icon_dest: assets
            copy_mode: expo

          # ── WPF (C#) ──
          - repo: win-app-insight-pinboard
            product: PINBOARD
            name: InsightPinBoard
            icon_src: InsightPinBoard
            icon_dest: Resources
            copy_mode: ico_png

          # ── Web (Expo build) ──
          - repo: web-app-insight-qr
            product: QR
            name: InsightQR
            icon_src: InsightQR
            icon_dest: assets
            copy_mode: expo

          # ── Android Native (Voice Task Calendar) ──
          - repo: android-app-voice-tesk-calendar
            product: VOICE_TASK_CALENDAR
            name: InsightVoiceTaskCalendar
            icon_src: InsightVoiceTaskCalendar
            icon_dest: app/src/main/res
            copy_mode: android_native

    steps:
      - name: Validate SYNC_PAT secret
        run: |
          if [ -z "${{ secrets.SYNC_PAT }}" ]; then
            echo "::error::SYNC_PAT secret is not configured. Please add a Personal Access Token with 'repo' scope to the repository secrets."
            echo "::error::Settings ↁESecrets and variables ↁEActions ↁENew repository secret ↁEName: SYNC_PAT"
            exit 1
          fi

      - name: Check if repo should be synced
        id: check
        run: |
          FILTER="${{ inputs.repos }}"
          if [ -n "$FILTER" ]; then
            if echo "$FILTER" | grep -qw "${{ matrix.repo }}"; then
              echo "skip=false" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout insight-common
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          path: insight-common

      - name: Checkout target repo
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: HarmonicInsight/${{ matrix.repo }}
          token: ${{ secrets.SYNC_PAT }}
          path: target-repo
          submodules: true
          fetch-depth: 0

      - name: Update submodule reference (optional)
        if: steps.check.outputs.skip != 'true' && inputs.sync_submodule == true
        working-directory: target-repo
        run: |
          COMMON_SHA="${{ github.sha }}"

          # Auto-detect submodule path
          SUBMODULE=""
          for path in insight-common lib-insight-common; do
            if [ -d "$path" ]; then
              SUBMODULE="$path"
              break
            fi
          done

          if [ -z "$SUBMODULE" ]; then
            echo "No submodule found  Eskipping submodule update for ${{ matrix.repo }}"
            exit 0
          fi

          echo "Detected submodule path: $SUBMODULE"

          cd "$SUBMODULE"
          CURRENT_URL=$(git remote get-url origin)
          if [[ "$CURRENT_URL" != *"cross-lib-insight-common"* ]]; then
            echo "Updating remote URL from $CURRENT_URL to cross-lib-insight-common"
            git remote set-url origin https://github.com/HarmonicInsight/cross-lib-insight-common.git
          fi
          git fetch origin main
          git checkout "$COMMON_SHA"
          cd ..

      - name: Copy icons
        if: steps.check.outputs.skip != 'true'
        run: |
          SRC_BASE="insight-common/${{ env.ICON_SRC_BASE }}"
          DEST_BASE="target-repo"
          MODE="${{ matrix.copy_mode }}"
          ICON_SRC="${{ matrix.icon_src }}"
          ICON_DEST="${{ matrix.icon_dest }}"
          NAME="${{ matrix.name }}"

          mkdir -p "$DEST_BASE/$ICON_DEST"

          case "$MODE" in
            dir)
              cp -r "$SRC_BASE/$ICON_SRC"* "$DEST_BASE/$ICON_DEST"
              echo "Copied directory: $ICON_SRC -> $ICON_DEST"
              ;;
            ico_png)
              cp "$SRC_BASE/$ICON_SRC/$NAME.ico" "$DEST_BASE/$ICON_DEST/$NAME.ico"
              cp "$SRC_BASE/$ICON_SRC/${NAME}_256.png" "$DEST_BASE/$ICON_DEST/${NAME}_256.png"
              echo "Copied: $NAME.ico + ${NAME}_256.png -> $ICON_DEST"
              ;;
            android_native)
              for subdir in drawable mipmap-anydpi-v26; do
                if [ -d "$SRC_BASE/$ICON_SRC/$subdir" ]; then
                  mkdir -p "$DEST_BASE/$ICON_DEST/$subdir"
                  cp "$SRC_BASE/$ICON_SRC/$subdir/"*.xml "$DEST_BASE/$ICON_DEST/$subdir/"
                fi
              done
              echo "Copied Android native drawables -> $ICON_DEST"
              ;;
            expo)
              for f in icon.png adaptive-icon.png notification-icon.png splash-icon.png favicon.png; do
                [ -f "$SRC_BASE/$ICON_SRC/$f" ] && cp "$SRC_BASE/$ICON_SRC/$f" "$DEST_BASE/$ICON_DEST/$f"
              done
              if [ -d "$SRC_BASE/$ICON_SRC/android" ]; then
                cp -r "$SRC_BASE/$ICON_SRC/android/"* "$DEST_BASE/$ICON_DEST/" 2>/dev/null || true
              fi
              echo "Copied Expo icons + Android mipmaps -> $ICON_DEST"
              ;;
            web)
              cp "$SRC_BASE/$ICON_SRC/favicon.ico" "$DEST_BASE/$ICON_DEST/favicon.ico"
              cp "$SRC_BASE/$ICON_SRC/favicon-16.png" "$DEST_BASE/$ICON_DEST/favicon-16x16.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/favicon-32.png" "$DEST_BASE/$ICON_DEST/favicon-32x32.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/apple-touch-icon.png" "$DEST_BASE/$ICON_DEST/apple-touch-icon.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/icon-192.png" "$DEST_BASE/$ICON_DEST/icon-192.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/icon-512.png" "$DEST_BASE/$ICON_DEST/icon-512.png" 2>/dev/null || true
              echo "Copied web icons -> $ICON_DEST"
              ;;
          esac

      - name: Check for icon file changes only
        if: steps.check.outputs.skip != 'true'
        id: changes
        working-directory: target-repo
        run: |
          # アイコンファイルのみスチE�Eジング�E�サブモジュール参�Eは除外！E
          ICON_DEST="${{ matrix.icon_dest }}"
          git add "$ICON_DEST"

          # サブモジュール更新がある場合�EみスチE�Eジング
          if [ "${{ inputs.sync_submodule }}" = "true" ]; then
            for path in insight-common lib-insight-common; do
              [ -d "$path" ] && git add "$path"
            done
          fi

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No icon changes in ${{ matrix.repo }}"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Icon changes detected in ${{ matrix.repo }}:"
            git diff --cached --stat
          fi

      - name: Create or update PR
        if: >-
          steps.check.outputs.skip != 'true' &&
          steps.changes.outputs.has_changes == 'true' &&
          inputs.dry_run != true
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # 固定ブランチ名を使用�E�EHA ごとに新ブランチを作らなぁE��E
          BRANCH="chore/sync-icons"
          COMMIT_MSG="chore: sync icons from insight-common (${SHORT_SHA})"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 既存�Eリモートブランチがあれば削除してから作�E
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git commit -m "$COMMIT_MSG"
          git push -u origin "$BRANCH"

          # 既存�E PR を探ぁE
          EXISTING=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists  Ebranch updated with latest icons"
          else
            gh pr create \
              --title "$COMMIT_MSG" \
              --body "$(cat <<EOF
          ## アイコン同期

          **変更允E*: HarmonicInsight/cross-lib-insight-common@${SHORT_SHA}
          **対象製品E*: ${{ matrix.name }} (${{ matrix.product }})

          ### 変更冁E��
          - アイコンファイルめEinsight-common から同期

          ### 確認手頁E
          1. ビルドが通ることを確誁E
          2. アイコンが正しく表示されることを確誁E

          ---
          *This PR was created by [sync-icons](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
          )"
            echo "PR created for ${{ matrix.repo }}"
          fi
