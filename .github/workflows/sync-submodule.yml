name: Sync icons to dependent repos

# 謇句虚螳溯｡後・縺ｿ縲・
# brand/icons 繧貞､画峩縺励◆蠕後∝ｿ・ｦ√↑繝ｪ繝昴ず繝医Μ縺ｫ繧｢繧､繧ｳ繝ｳ繧偵さ繝斐・縺励※ PR 繧剃ｽ懈・縺吶ｋ縲・
# push 繝医Μ繧ｬ繝ｼ縺ｯ辟｡蜉ｹ蛹匁ｸ医∩・育┌髯・PR 逕滓・繧帝亟豁｢・峨・

on:
  workflow_dispatch:
    inputs:
      repos:
        description: '蜷梧悄蟇ｾ雎｡繝ｪ繝昴ず繝医Μ・医き繝ｳ繝槫玄蛻・ｊ縲∫ｩｺ=蜈ｨ縺ｦ・・
        required: false
        type: string
      dry_run:
        description: 'Dry run・・R 繧剃ｽ懈・縺励↑縺・ｼ・
        required: false
        type: boolean
        default: false
      sync_submodule:
        description: '繧ｵ繝悶Δ繧ｸ繝･繝ｼ繝ｫ蜿ら・繧よ峩譁ｰ縺吶ｋ'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  ICON_SRC_BASE: brand/icons/generated
  SUBMODULE_PATH: insight-common

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          # 笏笏 Tier 1: 讌ｭ蜍吝､蛾擠繝・・繝ｫ 笏笏
          - repo: win-app-nocode-analyzer
            product: INCA
            name: InsightNoCodeAnalyzer
            icon_src: InsightNoCodeAnalyzer/
            icon_dest: src-tauri/icons/
            copy_mode: dir

          - repo: win-app-insight-bot
            product: INBT
            name: InsightBot
            icon_src: InsightBot
            icon_dest: Resources
            copy_mode: ico_png

          - repo: web-app-auto-interview
            product: IVIN
            name: InterviewInsight
            icon_src: InterviewInsight/
            icon_dest: src-tauri/icons/
            copy_mode: dir

          # 笏笏 Tier 2: AI豢ｻ逕ｨ繝・・繝ｫ 笏笏
          - repo: win-app-insight-cast
            product: INMV
            name: InsightCast
            icon_src: InsightCast
            icon_dest: resources
            copy_mode: ico_png

          - repo: win-app-insight-image-gen
            product: INIG
            name: InsightImageGen
            icon_src: InsightImageGen
            icon_dest: resources
            copy_mode: ico_png

          # 笏笏 Tier 3: InsightOffice Suite 笏笏
          - repo: win-app-insight-slide
            product: INSS
            name: InsightOfficeSlide
            icon_src: InsightOfficeSlide
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-sheet
            product: IOSH
            name: InsightOfficeSheet
            icon_src: InsightOfficeSheet
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-doc
            product: IOSD
            name: InsightOfficeDoc
            icon_src: InsightOfficeDoc
            icon_dest: Resources
            copy_mode: ico_png

          - repo: win-app-insight-py
            product: INPY
            name: InsightPy
            icon_src: InsightPy
            icon_dest: resources
            copy_mode: ico_png

          - repo: win-app-insight-py-pro
            product: INPY
            name: InsightPy
            icon_src: InsightPy
            icon_dest: resources
            copy_mode: ico_png

          # 笏笏 Tier 4: 繧ｷ繝九い蜷代¢ 笏笏
          - repo: win-app-insight-sheet-senior
            product: ISOF
            name: InsightSeniorOffice
            icon_src: InsightSeniorOffice
            icon_dest: Resources
            copy_mode: ico_png

          # 笏笏 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ 笏笏
          - repo: win-app-insight-launcher
            product: LAUNCHER
            name: InsightLauncher
            icon_src: InsightLauncher
            icon_dest: Resources
            copy_mode: ico_png

          - repo: android-app-insight-launcher
            product: LAUNCHER_ANDROID
            name: InsightLauncherAndroid
            icon_src: InsightLauncherAndroid
            icon_dest: app/src/main/res
            copy_mode: android_native

          # 笏笏 Android Native (Kotlin/Compose) 笏笏
          - repo: android-app-insight-voice-clock
            product: VOICE_CLOCK
            name: InsightVoiceClock
            icon_src: InsightVoiceClock
            icon_dest: app/src/main/res
            copy_mode: android_native

          - repo: android-app-insight-camera
            product: CAMERA
            name: InsightCamera
            icon_src: InsightCamera
            icon_dest: app/src/main/res
            copy_mode: android_native

          # 笏笏 Expo / React Native 笏笏
          - repo: mobile-app-voice-memo
            product: VOICE_MEMO
            name: InsightVoiceMemo
            icon_src: InsightVoiceMemo
            icon_dest: assets
            copy_mode: expo

          # 笏笏 WPF (C#) 笏笏
          - repo: win-app-insight-pinboard
            product: PINBOARD
            name: InsightPinBoard
            icon_src: InsightPinBoard
            icon_dest: Resources
            copy_mode: ico_png

          # 笏笏 Web (Expo build) 笏笏
          - repo: web-app-insight-qr
            product: QR
            name: InsightQR
            icon_src: InsightQR
            icon_dest: assets
            copy_mode: expo

          # 笏笏 Android Native (Voice Task Calendar) 笏笏
          - repo: android-app-voice-tesk-calendar
            product: VOICE_TASK_CALENDAR
            name: InsightVoiceTaskCalendar
            icon_src: InsightVoiceTaskCalendar
            icon_dest: app/src/main/res
            copy_mode: android_native

    steps:
      - name: Validate SYNC_PAT secret
        run: |
          if [ -z "${{ secrets.SYNC_PAT }}" ]; then
            echo "::error::SYNC_PAT secret is not configured. Please add a Personal Access Token with 'repo' scope to the repository secrets."
            echo "::error::Settings 竊・Secrets and variables 竊・Actions 竊・New repository secret 竊・Name: SYNC_PAT"
            exit 1
          fi

      - name: Check if repo should be synced
        id: check
        run: |
          FILTER="${{ inputs.repos }}"
          if [ -n "$FILTER" ]; then
            if echo "$FILTER" | grep -qw "${{ matrix.repo }}"; then
              echo "skip=false" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout insight-common
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          path: insight-common

      - name: Checkout target repo
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: HarmonicInsight/${{ matrix.repo }}
          token: ${{ secrets.SYNC_PAT }}
          path: target-repo
          submodules: true
          fetch-depth: 0

      - name: Update submodule reference (optional)
        if: steps.check.outputs.skip != 'true' && inputs.sync_submodule == true
        working-directory: target-repo
        run: |
          COMMON_SHA="${{ github.sha }}"

          # Auto-detect submodule path
          SUBMODULE=""
          for path in insight-common lib-insight-common; do
            if [ -d "$path" ]; then
              SUBMODULE="$path"
              break
            fi
          done

          if [ -z "$SUBMODULE" ]; then
            echo "No submodule found 窶・skipping submodule update for ${{ matrix.repo }}"
            exit 0
          fi

          echo "Detected submodule path: $SUBMODULE"

          cd "$SUBMODULE"
          CURRENT_URL=$(git remote get-url origin)
          if [[ "$CURRENT_URL" != *"cross-lib-insight-common"* ]]; then
            echo "Updating remote URL from $CURRENT_URL to cross-lib-insight-common"
            git remote set-url origin https://github.com/HarmonicInsight/cross-lib-insight-common.git
          fi
          git fetch origin main
          git checkout "$COMMON_SHA"
          cd ..

      - name: Copy icons
        if: steps.check.outputs.skip != 'true'
        run: |
          SRC_BASE="insight-common/${{ env.ICON_SRC_BASE }}"
          DEST_BASE="target-repo"
          MODE="${{ matrix.copy_mode }}"
          ICON_SRC="${{ matrix.icon_src }}"
          ICON_DEST="${{ matrix.icon_dest }}"
          NAME="${{ matrix.name }}"

          mkdir -p "$DEST_BASE/$ICON_DEST"

          case "$MODE" in
            dir)
              cp -r "$SRC_BASE/$ICON_SRC"* "$DEST_BASE/$ICON_DEST"
              echo "Copied directory: $ICON_SRC -> $ICON_DEST"
              ;;
            ico_png)
              cp "$SRC_BASE/$ICON_SRC/$NAME.ico" "$DEST_BASE/$ICON_DEST/$NAME.ico"
              cp "$SRC_BASE/$ICON_SRC/${NAME}_256.png" "$DEST_BASE/$ICON_DEST/${NAME}_256.png"
              echo "Copied: $NAME.ico + ${NAME}_256.png -> $ICON_DEST"
              ;;
            android_native)
              for subdir in drawable mipmap-anydpi-v26; do
                if [ -d "$SRC_BASE/$ICON_SRC/$subdir" ]; then
                  mkdir -p "$DEST_BASE/$ICON_DEST/$subdir"
                  cp "$SRC_BASE/$ICON_SRC/$subdir/"*.xml "$DEST_BASE/$ICON_DEST/$subdir/"
                fi
              done
              echo "Copied Android native drawables -> $ICON_DEST"
              ;;
            expo)
              for f in icon.png adaptive-icon.png notification-icon.png splash-icon.png favicon.png; do
                [ -f "$SRC_BASE/$ICON_SRC/$f" ] && cp "$SRC_BASE/$ICON_SRC/$f" "$DEST_BASE/$ICON_DEST/$f"
              done
              if [ -d "$SRC_BASE/$ICON_SRC/android" ]; then
                cp -r "$SRC_BASE/$ICON_SRC/android/"* "$DEST_BASE/$ICON_DEST/" 2>/dev/null || true
              fi
              echo "Copied Expo icons + Android mipmaps -> $ICON_DEST"
              ;;
            web)
              cp "$SRC_BASE/$ICON_SRC/favicon.ico" "$DEST_BASE/$ICON_DEST/favicon.ico"
              cp "$SRC_BASE/$ICON_SRC/favicon-16.png" "$DEST_BASE/$ICON_DEST/favicon-16x16.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/favicon-32.png" "$DEST_BASE/$ICON_DEST/favicon-32x32.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/apple-touch-icon.png" "$DEST_BASE/$ICON_DEST/apple-touch-icon.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/icon-192.png" "$DEST_BASE/$ICON_DEST/icon-192.png" 2>/dev/null || true
              cp "$SRC_BASE/$ICON_SRC/icon-512.png" "$DEST_BASE/$ICON_DEST/icon-512.png" 2>/dev/null || true
              echo "Copied web icons -> $ICON_DEST"
              ;;
          esac

      - name: Check for icon file changes only
        if: steps.check.outputs.skip != 'true'
        id: changes
        working-directory: target-repo
        run: |
          # 繧｢繧､繧ｳ繝ｳ繝輔ぃ繧､繝ｫ縺ｮ縺ｿ繧ｹ繝・・繧ｸ繝ｳ繧ｰ・医し繝悶Δ繧ｸ繝･繝ｼ繝ｫ蜿ら・縺ｯ髯､螟厄ｼ・
          ICON_DEST="${{ matrix.icon_dest }}"
          git add "$ICON_DEST"

          # 繧ｵ繝悶Δ繧ｸ繝･繝ｼ繝ｫ譖ｴ譁ｰ縺後≠繧句ｴ蜷医・縺ｿ繧ｹ繝・・繧ｸ繝ｳ繧ｰ
          if [ "${{ inputs.sync_submodule }}" = "true" ]; then
            for path in insight-common lib-insight-common; do
              [ -d "$path" ] && git add "$path"
            done
          fi

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No icon changes in ${{ matrix.repo }}"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Icon changes detected in ${{ matrix.repo }}:"
            git diff --cached --stat
          fi

      - name: Create or update PR
        if: >-
          steps.check.outputs.skip != 'true' &&
          steps.changes.outputs.has_changes == 'true' &&
          inputs.dry_run != true
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # 蝗ｺ螳壹ヶ繝ｩ繝ｳ繝∝錐繧剃ｽｿ逕ｨ・・HA 縺斐→縺ｫ譁ｰ繝悶Λ繝ｳ繝√ｒ菴懊ｉ縺ｪ縺・ｼ・
          BRANCH="chore/sync-icons"
          COMMIT_MSG="chore: sync icons from insight-common (${SHORT_SHA})"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 譌｢蟄倥・繝ｪ繝｢繝ｼ繝医ヶ繝ｩ繝ｳ繝√′縺ゅｌ縺ｰ蜑企勁縺励※縺九ｉ菴懈・
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git commit -m "$COMMIT_MSG"
          git push -u origin "$BRANCH"

          # 譌｢蟄倥・ PR 繧呈爾縺・
          EXISTING=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists 窶・branch updated with latest icons"
          else
            gh pr create \
              --title "$COMMIT_MSG" \
              --body "$(cat <<EOF
          ## 繧｢繧､繧ｳ繝ｳ蜷梧悄

          **螟画峩蜈・*: HarmonicInsight/cross-lib-insight-common@${SHORT_SHA}
          **蟇ｾ雎｡陬ｽ蜩・*: ${{ matrix.name }} (${{ matrix.product }})

          ### 螟画峩蜀・ｮｹ
          - 繧｢繧､繧ｳ繝ｳ繝輔ぃ繧､繝ｫ繧・insight-common 縺九ｉ蜷梧悄

          ### 遒ｺ隱肴焔鬆・
          1. 繝薙Ν繝峨′騾壹ｋ縺薙→繧堤｢ｺ隱・
          2. 繧｢繧､繧ｳ繝ｳ縺梧ｭ｣縺励￥陦ｨ遉ｺ縺輔ｌ繧九％縺ｨ繧堤｢ｺ隱・

          ---
          *This PR was created by [sync-icons](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
          )"
            echo "PR created for ${{ matrix.repo }}"
          fi
