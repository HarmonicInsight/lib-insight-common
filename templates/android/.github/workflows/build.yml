# ============================================================
# Insight Android 標準 CI/CD ワークフロー
#
# 【このファイルについて】
# insight-common/templates/android/ からコピーして使用。
# __APPNAME__ を実際のパッケージ名に置換してください。
# Firebase を使わない場合は google-services.json ステップを削除。
# ============================================================

name: Build APK

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Firebase を使用している場合のみ（不要なら削除）
      - name: Create google-services.json for CI
        run: |
          if [ ! -f app/google-services.json ]; then
            cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "insight-app-ci",
              "storage_bucket": "insight-app-ci.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                  "android_client_info": {
                    "package_name": "com.harmonic.insight.__APPNAME__"
                  }
                },
                "api_key": [{ "current_key": "CI_PLACEHOLDER_KEY" }]
              }
            ]
          }
          GSEOF
          fi

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Display APK size
        run: |
          echo "=== Debug APK ==="
          find app/build/outputs/apk/debug/ -name "*.apk" -exec ls -lh {} \; 2>/dev/null || true
          echo "=== Release APK ==="
          find app/build/outputs/apk/release/ -name "*.apk" -exec ls -lh {} \; 2>/dev/null || true

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
