# ============================================================
# Insight iOS 標準 CI/CD ワークフロー
#
# 【このファイルについて】
# insight-common/templates/ios/ からコピーして使用。
# 以下のプレースホルダーを置換してください:
#   __AppName__          → Xcode スキーム名 (PascalCase, 例: Camera)
#   __APPNAME__          → ターゲットディレクトリ名 (小文字, 例: camera)
#   __APP_DISPLAY_NAME__ → アーティファクト名 (例: InsightCamera)
#
# 【必須 GitHub Secrets（Archive / App Store 配布時）】
#   APPLE_CERTIFICATE_BASE64  → base64 エンコードされた .p12 証明書
#   APPLE_CERTIFICATE_PASSWORD → 証明書のパスワード
#   APPLE_PROVISIONING_PROFILE_BASE64 → base64 エンコードされたプロビジョニングプロファイル
#   KEYCHAIN_PASSWORD          → CI 用キーチェーンのパスワード
# ============================================================

name: Build iOS

on:
  push:
    branches: [ main, 'claude/**' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: macos-14
    timeout-minutes: 30
    env:
      SCHEME: __AppName__
      DESTINATION: 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      # --- シミュレータビルド（全ブランチ） ---
      - name: Build for Simulator
        run: |
          xcodebuild build \
            -project __AppName__.xcodeproj \
            -scheme $SCHEME \
            -destination "$DESTINATION" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      # --- 署名シークレットの検証（タグリリース時は必須） ---
      - name: Require signing for releases
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          HAS_SIGNING: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        run: |
          if [ -z "$HAS_SIGNING" ]; then
            echo "::error::署名シークレットが未設定です。タグリリースにはコード署名が必須です。"
            echo "::error::GitHub Settings > Secrets and variables > Actions で以下を設定してください:"
            echo "::error::  APPLE_CERTIFICATE_BASE64, APPLE_CERTIFICATE_PASSWORD"
            echo "::error::  APPLE_PROVISIONING_PROFILE_BASE64, KEYCHAIN_PASSWORD"
            exit 1
          fi

      # --- 署名設定 + Archive（タグリリース時のみ） ---
      - name: Setup signing
        if: startsWith(github.ref, 'refs/tags/v') && env.HAS_SIGNING != ''
        env:
          HAS_SIGNING: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        run: |
          # キーチェーン作成
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH

          # 証明書インポート
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "${{ secrets.APPLE_CERTIFICATE_BASE64 }}" | base64 --decode > $CERTIFICATE_PATH
          security import $CERTIFICATE_PATH -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # プロビジョニングプロファイル
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

          echo "✅ コード署名を設定しました"

      - name: Archive for distribution
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          xcodebuild archive \
            -project __AppName__.xcodeproj \
            -scheme $SCHEME \
            -archivePath build/__AppName__.xcarchive \
            -destination 'generic/platform=iOS' \
            | xcpretty || true

      # --- アーティファクトアップロード ---
      - name: Upload archive
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: __APP_DISPLAY_NAME__-xcarchive
          path: build/__AppName__.xcarchive
          if-no-files-found: warn
          retention-days: 90

      # --- GitHub Release（タグ push 時のみ） ---
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
