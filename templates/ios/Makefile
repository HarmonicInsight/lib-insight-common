# ============================================================
# Insight iOS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ Makefile
#
# Xcode GUI ã«é ¼ã‚‰ãšã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰å…¨æ“ä½œã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹ã€‚
# XcodeGen + xcconfig + ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ Xcode åœ°ç„ã‚’å›é¿ã€‚
#
# ä½¿ã„æ–¹:
#   make setup       â€” åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (XcodeGen ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« + ç”Ÿæˆ)
#   make generate    â€” .xcodeproj ã‚’å†ç”Ÿæˆ
#   make build       â€” ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
#   make clean       â€” DerivedData + ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨å‰Šé™¤
#   make bump-patch  â€” ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1 (1.0.0 â†’ 1.0.1)
#   make bump-minor  â€” ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1 (1.0.0 â†’ 1.1.0)
#   make bump-major  â€” ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1 (1.0.0 â†’ 2.0.0)
#   make bump-build  â€” ãƒ“ãƒ«ãƒ‰ç•ªå· +1
#
# __AppName__ ã‚’å®Ÿéš›ã®ã‚¹ã‚­ãƒ¼ãƒ åã«ç½®æ›ã—ã¦ãã ã•ã„ã€‚
# ============================================================

SCHEME = __AppName__
PROJECT = __AppName__.xcodeproj
DESTINATION = platform=iOS Simulator,name=iPhone 16 Pro,OS=18.0
CONFIG_DIR = Configuration

.PHONY: setup generate build build-release clean nuke bump-patch bump-minor bump-major bump-build open help

# --- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
setup:
	@which xcodegen > /dev/null || (echo "Installing XcodeGen..." && brew install xcodegen)
	@xcodegen generate
	@echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆå®Œäº†: $(PROJECT)"

# --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ ---
generate:
	@xcodegen generate
	@echo "âœ… $(PROJECT) ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ"

# --- ãƒ“ãƒ«ãƒ‰ ---
build: generate
	xcodebuild build \
		-project $(PROJECT) \
		-scheme $(SCHEME) \
		-destination "$(DESTINATION)" \
		-configuration Debug \
		CODE_SIGNING_ALLOWED=NO \
		| xcpretty

build-release: generate
	xcodebuild build \
		-project $(PROJECT) \
		-scheme $(SCHEME) \
		-destination "$(DESTINATION)" \
		-configuration Release \
		CODE_SIGNING_ALLOWED=NO \
		| xcpretty

# --- ã‚¯ãƒªãƒ¼ãƒ³ ---
clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤..."
	@rm -rf build/
	@xcodebuild clean -project $(PROJECT) -scheme $(SCHEME) 2>/dev/null || true
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†"

# DerivedData å«ã‚€å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆXcode ã‚­ãƒ£ãƒƒã‚·ãƒ¥è…æ•—æ™‚ã«ä½¿ç”¨ï¼‰
nuke:
	@echo "ğŸ’£ DerivedData ã‚’å®Œå…¨å‰Šé™¤..."
	@rm -rf ~/Library/Developer/Xcode/DerivedData/*$(SCHEME)*
	@rm -rf build/
	@rm -rf $(PROJECT)
	@echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†ã€‚make generate ã§å†ç”Ÿæˆã—ã¦ãã ã•ã„"

# --- Xcode ã§é–‹ã ---
open: generate
	@open $(PROJECT)

# --- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† ---
# Base.xcconfig ã¨ project.yml ã®ä¸¡æ–¹ã‚’åŒæœŸæ›´æ–°

bump-patch:
	@$(call _bump_version,patch)

bump-minor:
	@$(call _bump_version,minor)

bump-major:
	@$(call _bump_version,major)

bump-build:
	@CURRENT=$$(grep 'CURRENT_PROJECT_VERSION' $(CONFIG_DIR)/Base.xcconfig | sed 's/.*= *//'); \
	NEW=$$((CURRENT + 1)); \
	sed -i '' "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $$NEW/" $(CONFIG_DIR)/Base.xcconfig; \
	sed -i '' "s/CURRENT_PROJECT_VERSION: .*/CURRENT_PROJECT_VERSION: $$NEW/" project.yml; \
	echo "âœ… Build: $$CURRENT â†’ $$NEW"

define _bump_version
	@CURRENT=$$(grep 'MARKETING_VERSION' $(CONFIG_DIR)/Base.xcconfig | sed 's/.*= *//'); \
	MAJOR=$$(echo $$CURRENT | cut -d. -f1); \
	MINOR=$$(echo $$CURRENT | cut -d. -f2); \
	PATCH=$$(echo $$CURRENT | cut -d. -f3); \
	case "$(1)" in \
		major) MAJOR=$$((MAJOR + 1)); MINOR=0; PATCH=0 ;; \
		minor) MINOR=$$((MINOR + 1)); PATCH=0 ;; \
		patch) PATCH=$$((PATCH + 1)) ;; \
	esac; \
	NEW="$$MAJOR.$$MINOR.$$PATCH"; \
	sed -i '' "s/MARKETING_VERSION = .*/MARKETING_VERSION = $$NEW/" $(CONFIG_DIR)/Base.xcconfig; \
	sed -i '' "s/MARKETING_VERSION: .*/MARKETING_VERSION: $$NEW/" project.yml; \
	BUILD=$$(grep 'CURRENT_PROJECT_VERSION' $(CONFIG_DIR)/Base.xcconfig | sed 's/.*= *//'); \
	NEW_BUILD=$$((BUILD + 1)); \
	sed -i '' "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $$NEW_BUILD/" $(CONFIG_DIR)/Base.xcconfig; \
	sed -i '' "s/CURRENT_PROJECT_VERSION: .*/CURRENT_PROJECT_VERSION: $$NEW_BUILD/" project.yml; \
	echo "âœ… Version: $$CURRENT â†’ $$NEW (Build: $$BUILD â†’ $$NEW_BUILD)"
endef

# --- ãƒ˜ãƒ«ãƒ— ---
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make setup        â€” åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@echo "  make generate     â€” .xcodeproj ã‚’å†ç”Ÿæˆ"
	@echo "  make build        â€” ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼‰"
	@echo "  make build-release â€” ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼‰"
	@echo "  make clean        â€” ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤"
	@echo "  make nuke         â€” DerivedData å®Œå…¨å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è…æ•—æ™‚ï¼‰"
	@echo "  make open         â€” Xcode ã§é–‹ã"
	@echo "  make bump-patch   â€” ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1"
	@echo "  make bump-minor   â€” ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1"
	@echo "  make bump-major   â€” ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ +1"
	@echo "  make bump-build   â€” ãƒ“ãƒ«ãƒ‰ç•ªå· +1"
