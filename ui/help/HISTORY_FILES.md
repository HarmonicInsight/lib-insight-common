# 履歴ファイル（.hsheet）について

> InsightOfficeSheet は、Excel ファイルを編集・保存するたびに **変更履歴** を自動的に記録します。
> この履歴は `.hsheet` という拡張子のファイルとして、元の Excel ファイルと同じフォルダに保存されます。

---

## 仕組み

### 保存場所

履歴ファイルは、**元の Excel ファイルと同じフォルダ**に、**拡張子だけを `.hsheet` に変えた名前**で保存されます。

```
例:
  元のファイル  : C:\Users\data\売上.xlsx
  履歴ファイル  : C:\Users\data\売上.hsheet    ← これが履歴ファイル
```

```
例:
  元のファイル  : D:\経理\2025年度\請求書一覧.xlsx
  履歴ファイル  : D:\経理\2025年度\請求書一覧.hsheet
```

### ファイル形式

`.hsheet` ファイルの実体は **ZIP アーカイブ** です。中には以下の情報が含まれています。

| 内容 | 説明 |
|------|------|
| 変更履歴データ | いつ・どのセルが・どう変わったかの記録 |
| スナップショット | 各保存時点のシート内容のバックアップ |
| メタ情報 | ファイル名、シート構成、最終更新日時など |

```
売上.hsheet（ZIPアーカイブ）
  ├── manifest.json          ← メタ情報
  ├── history/
  │   ├── 001_20260115_0930.json   ← 1回目の変更記録
  │   ├── 002_20260115_1045.json   ← 2回目の変更記録
  │   └── 003_20260120_1400.json   ← 3回目の変更記録
  └── snapshots/
      ├── 001_20260115_0930.xlsx   ← 1回目の保存時点のExcel
      └── latest.xlsx              ← 最新のスナップショット
```

---

## 履歴ファイルの使い方

### 変更履歴を見る

1. InsightOfficeSheet でExcel ファイルを開く
2. メニューの「**変更履歴**」（Ctrl + H）をクリック
3. 変更の一覧が時系列で表示されます

```
┌─────────────────────────────────────────────────────┐
│  📋 変更履歴: 売上.xlsx                              │
├─────────────────────────────────────────────────────┤
│                                                     │
│  🕐 2026/01/20 14:00  3回目の保存                   │
│     Sheet1!B5: 150 → 180                            │
│     Sheet1!D5: =B5*C5（再計算）                     │
│                                                     │
│  🕐 2026/01/15 10:45  2回目の保存                   │
│     Sheet1!A8: （空白）→ バナナ                     │
│     Sheet1!B8: （空白）→ 200                        │
│     Sheet1!C8: （空白）→ 50                         │
│                                                     │
│  🕐 2026/01/15 09:30  初回読み込み                  │
│     （ベースライン作成）                             │
│                                                     │
│  [特定の時点に戻す]  [履歴をエクスポート]           │
└─────────────────────────────────────────────────────┘
```

### 過去のバージョンに戻す

1. 変更履歴の一覧から、戻したい時点を選択
2. 「**この時点に戻す**」をクリック
3. 確認ダイアログで「OK」をクリック

> **注意**: 戻す操作自体も履歴に記録されるので、さらに戻すことも可能です。

---

## 注意事項

### ファイルサイズについて

- 履歴ファイル（.hsheet）は変更のたびに大きくなります
- 大きな Excel ファイルを何度も編集すると、履歴ファイルも大きくなります
- ディスク容量が気になる場合は、古い履歴を整理（後述）できます

### 履歴ファイルを削除してもよいか

| 状況 | 削除 |
|------|------|
| 履歴が不要な場合 | 削除しても Excel ファイル自体には影響しません |
| 履歴を残したい場合 | 削除しないでください（復元できなくなります） |

> **重要**: `.hsheet` ファイルを削除しても、元の Excel ファイルは影響を受けません。
> ただし、変更履歴や過去のバージョンに戻す機能は使えなくなります。

### ファイルの移動・コピーについて

| 操作 | 注意点 |
|------|--------|
| Excel ファイルだけ移動 | 履歴ファイルとの紐づけが切れます |
| Excel + .hsheet を一緒に移動 | 問題なく使えます |
| Excel ファイルの名前を変更 | 履歴ファイルの名前も手動で変更が必要です |

```
✅ 正しい移動方法:
   売上.xlsx     → 新しいフォルダ\売上.xlsx
   売上.hsheet   → 新しいフォルダ\売上.hsheet   ← 一緒に移動！

❌ やりがちなミス:
   売上.xlsx     → 新しいフォルダ\売上.xlsx
   売上.hsheet   → （移動し忘れ）               ← 履歴が見えなくなる
```

```
✅ 正しいリネーム:
   売上.xlsx     → 売上_2026年版.xlsx
   売上.hsheet   → 売上_2026年版.hsheet          ← 名前を揃える！

❌ やりがちなミス:
   売上.xlsx     → 売上_2026年版.xlsx
   売上.hsheet   → （そのまま）                  ← 名前が合わないので紐づけ切れ
```

### 共有フォルダ・OneDrive での利用

- 共有フォルダに `.hsheet` ファイルがある場合、他のユーザーの操作と競合する可能性があります
- **推奨**: 共有フォルダの Excel を編集する場合は、ローカルにコピーしてから作業してください
- OneDrive の同期フォルダでも同様の注意が必要です

### .hsheet ファイルの中身を直接見たい場合

`.hsheet` ファイルは ZIP 形式です。拡張子を `.zip` に変えることで中身を確認できます。

```
手順:
  1. 売上.hsheet を 売上.zip にリネーム
  2. 売上.zip をダブルクリック（またはエクスプローラーで開く）
  3. 中の JSON ファイルやスナップショットが確認できます
```

> **注意**: 中のファイルを直接編集すると履歴データが壊れる可能性があります。
> 確認のみにとどめ、編集は InsightOfficeSheet から行ってください。

---

## 履歴の整理（古い履歴の削除）

1. InsightOfficeSheet でExcel ファイルを開く
2. メニューの「**変更履歴**」→「**履歴の整理**」を選択
3. 保持する期間を選択
   - 直近1ヶ月
   - 直近3ヶ月
   - 直近6ヶ月
   - すべて保持
4. 「整理する」をクリック

> 整理すると、指定期間より古いスナップショットが削除され、ファイルサイズが小さくなります。

---

## まとめ

| 項目 | 内容 |
|------|------|
| ファイル名 | 元のExcelと同名で拡張子が `.hsheet` |
| 保存場所 | 元のExcelと同じフォルダ |
| ファイル形式 | ZIPアーカイブ |
| 自動作成 | InsightOfficeSheet で保存するたびに自動作成・更新 |
| 削除の影響 | Excel 本体には影響なし（履歴のみ失われる） |
| 移動時の注意 | Excel と .hsheet は必ず一緒に移動する |
| リネーム時の注意 | Excel と .hsheet の名前を必ず揃える |
